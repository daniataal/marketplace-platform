generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Deal {
  id                   String          @id @default(uuid())
  externalId           String          @unique
  company              String
  commodity            String
  quantity             Float
  availableQuantity    Float           @default(0) @map("available_quantity")
  pricePerKg           Float
  discount             Float
  status               String          @default("OPEN")
  deliveryLocation     String          @default("Dubai")
  incoterms            String          @default("CIF")
  type                 String          @default("BULLION")
  purity               Float           @default(0.9999)
  pricingModel         String          @default("FIXED")
  marketPrice          Float           @default(0)
  cfRisk               String          @default("Low")
  cfTargetApy          Float           @default(12.5)
  cfDuration           Int             @default(12)
  cfMinInvestment      Float           @default(500)
  cfOrigin             String          @default("")
  cfTransportMethod    String          @default("Air Freight")
  // Crowdfunding export parameters (defaults for when purchases are exported)
  cfType               String          @default("Metals") // Metals, etc.
  cfIcon               String          @default("gold-bar")
  crowdfundingId       String?
  buyerId              String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  cfOriginPort         String          @default("")
  sellerAddress        String?
  sellerCountry        String?
  sellerEmail          String?
  sellerPassportExpiry String?
  sellerPassportNumber String?
  sellerRepresentative String?
  sellerTelephone      String?
  sellerTradeLicense   String?
  sellerId             String?
  frequency            String          @default("SPOT")
  contractDuration     Int             @default(1)
  extensionYears       Int             @default(5)
  totalQuantity        Float?
  annualValue          Float           @default(0)
  totalValue           Float           @default(0)
  buyer                User?           @relation("DealBuyer", fields: [buyerId], references: [id])
  seller               SellerIdentity? @relation(fields: [sellerId], references: [id])
  pendingExports       PendingExport[]
  purchases            Purchase[]
}

model User {
  id                  String         @id @default(cuid())
  name                String?
  email               String         @unique
  password            String
  role                String         @default("USER")
  balance             Float          @default(0)
  walletFrozen        Boolean        @default(false)
  kycStatus           String         @default("PENDING")
  firstName           String?
  lastName            String?
  address             String?
  passportNumber      String?
  nationality         String?
  kycDocuments        Json?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  passportExpiry      String?
  phoneNumber         String?
  companyDocUrl       String?
  companyName         String?
  companyRegistration String?
  idPassportUrl       String?
  userType            String         @default("INDIVIDUAL")
  deals               Deal[]         @relation("DealBuyer")
  notifications       Notification[]
  purchases           Purchase[]
  transactions        Transaction[]
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model Transaction {
  id        String   @id @default(uuid())
  userId    String
  type      String
  amount    Float
  status    String   @default("COMPLETED")
  reference String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Purchase {
  id               String          @id @default(uuid())
  dealId           String
  buyerId          String
  quantity         Float
  pricePerKg       Float
  totalPrice       Float
  deliveryLocation String
  status           String          @default("PENDING")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  logisticsCompany String?
  trackingNumber   String?
  shippedAt        DateTime?
  deliveredAt      DateTime?
  logisticsNotes   String?
  agreement        Agreement?
  pendingExports   PendingExport[]
  buyer            User            @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  deal             Deal            @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([buyerId])
}

model Agreement {
  id            String   @id @default(uuid())
  purchaseId    String   @unique
  buyerName     String
  sellerName    String
  agreementDate DateTime @default(now())
  spaData       Json?
  terms         String?
  status        String   @default("DRAFT")
  pdfUrl        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  purchase      Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
}

model PendingExport {
  id                String    @id @default(uuid())
  purchaseId        String
  dealId            String
  cfType            String    @default("Metals")
  cfName            String
  cfIcon            String
  cfRisk            String
  cfTargetApy       Float
  cfDuration        Int
  cfMinInvestment   Float
  cfAmountRequired  Float
  cfDescription     String
  cfOrigin          String
  cfDestination     String
  cfTransportMethod String
  cfMetalForm       String
  cfPurityPercent   Float
  cfFrequency       String   @default("SPOT") // SPOT, WEEKLY, BIWEEKLY, MONTHLY, QUARTERLY
  status            String    @default("PENDING")
  crowdfundingId    String?
  reviewedBy        String?
  reviewedAt        DateTime?
  rejectionReason   String?
  exportedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  purchase          Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([dealId])
  @@index([status])
}

model SellerIdentity {
  id             String   @id @default(cuid())
  alias          String?
  companyName    String
  originCountry  String?
  originPort     String?
  address        String?
  tradeLicense   String?
  representative String?
  passportNumber String?
  passportExpiry String?
  country        String?
  telephone      String?
  email          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  logo           String?
  deals          Deal[]
}
